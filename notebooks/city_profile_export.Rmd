---
title: "`r params$city` City Profile"
output: 
  pdf_document:
    latex_engine: xelatex
params:
  city: "Des Moines"
  city_data: NULL
  scores: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(knitr)
library(kableExtra)
library(ggplot2)
library(dplyr)
```

# `r params$city`, Iowa

**Report Generated:** `r format(Sys.Date(), "%B %d, %Y")`

---

## Overall Ranking

```{r ranking}
city_data <- params$city_data

if (!is.null(city_data) && nrow(city_data) > 0) {
  cat(paste0("**#", city_data$rank, "** out of ", nrow(params$scores), " Iowa cities analyzed"))
  cat("\n\n")
  cat(paste0("**Overall Score:** ", round(city_data$overall_score, 1), " / 100"))
} else {
  cat("City data not available")
}
```

---

## Score Summary

```{r scores-table}
if (!is.null(city_data) && nrow(city_data) > 0) {
  score_summary <- data.frame(
    Category = c("Safety", "Housing", "Education", "Economy", "Healthcare", "Livability"),
    Score = c(
      round(city_data$safety_score, 1),
      round(city_data$housing_score, 1),
      round(city_data$education_score, 1),
      round(city_data$economic_score, 1),
      round(city_data$healthcare_score, 1),
      round(city_data$livability_score_calc, 1)
    )
  )
  
  score_summary %>%
    kable(format = "latex", booktabs = TRUE, align = c("l", "r")) %>%
    kable_styling(latex_options = c("striped", "hold_position"), full_width = FALSE)
}
```

---

## Score Visualization

```{r scores-chart, fig.width=6, fig.height=3.5}
if (!is.null(city_data) && nrow(city_data) > 0) {
  score_df <- data.frame(
    Category = c("Safety", "Housing", "Education", "Economy", "Healthcare", "Livability"),
    Score = c(
      city_data$safety_score,
      city_data$housing_score,
      city_data$education_score,
      city_data$economic_score,
      city_data$healthcare_score,
      city_data$livability_score_calc
    )
  )
  
  ggplot(score_df, aes(x = reorder(Category, Score), y = Score, fill = Score)) +
    geom_col() +
    geom_text(aes(label = round(Score, 1)), hjust = -0.2, size = 3) +
    coord_flip() +
    scale_fill_viridis_c(option = "D") +
    scale_y_continuous(limits = c(0, 110)) +
    labs(x = NULL, y = "Score") +
    theme_minimal() +
    theme(
      legend.position = "none",
      panel.grid.major.y = element_blank()
    )
}
```

---

## Key Statistics

```{r stats-table}
if (!is.null(city_data) && nrow(city_data) > 0) {
  stats <- data.frame(
    Metric = c(
      "Population",
      "Region",
      "Median Household Income",
      "Median Home Value",
      "Violent Crime Rate (per 1,000)",
      "Graduation Rate",
      "Unemployment Rate",
      "Life Expectancy"
    ),
    Value = c(
      format(city_data$population, big.mark = ","),
      city_data$region,
      paste0("$", format(city_data$median_household_income, big.mark = ",")),
      paste0("$", format(city_data$median_home_value, big.mark = ",")),
      round(city_data$violent_crime_rate, 2),
      paste0(city_data$graduation_rate, "%"),
      paste0(city_data$unemployment_rate, "%"),
      paste0(city_data$life_expectancy, " years")
    )
  )
  
  stats %>%
    kable(format = "latex", booktabs = TRUE, align = c("l", "r")) %>%
    kable_styling(latex_options = c("striped", "hold_position"), full_width = FALSE)
}
```

---

## About This Report

This report was generated by the **Iowa Cities Dashboard**, a comprehensive analysis tool for comparing cities across Iowa based on multiple quality-of-life factors.

**Data Sources:**

- U.S. Census Bureau (2020)
- Iowa Department of Public Safety
- Iowa Department of Education
- Local government records

**Scoring Methodology:**

Each category score is calculated by normalizing relevant metrics to a 0-100 scale, where higher scores indicate better performance. The overall score is a weighted average of all category scores.

---

*Iowa Cities Dashboard â€¢ `r format(Sys.Date(), "%Y")`*
